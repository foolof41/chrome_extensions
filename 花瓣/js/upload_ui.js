"use strict";var HIDE_ERROR_INFO_DELAY_TIME=5000;var ShareButton={pin:null,init:function(){var b=document.querySelectorAll("#pin-done .share-button");for(var a=0;a<b.length;a++){b[a].addEventListener("click",function(){if(this.classList.contains("disabled")){return}if(!ShareButton.pin){return}var d="http://"+DOMAIN+"/pins/"+ShareButton.pin.pin_id;var h=Utils.getImgUrl(ShareButton.pin.file,"fw554");var g=ShareButton.pin.raw_text;var e=["url="+encodeURIComponent(d)];if(this.id=="share_sinaweibo"){var c="http://v.t.sina.com.cn/share/share.php?";e.push("&appkey=2499394483");e.push("&pic="+encodeURIComponent(h));e.push("&ralateUid=2493118952");e.push("&title="+encodeURIComponent(g))}else{if(this.id=="share_douban"){var c="http://www.douban.com/recommend/?";e.push("&title="+encodeURIComponent(g));e.push("&comment="+encodeURIComponent(g))}else{if(this.id=="share_qzone"){var c="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";e.push("&title="+encodeURIComponent(g));e.push("&pics="+encodeURIComponent(h))}}}e=e.join("");(function(i,k,j){function f(){if(!window.open([c,e].join(""),"mb",["toolbar=0,status=0,resizable=1,width=620,height=450,left=",(i.width-620)/2,",top=",(i.height-450)/2].join(""))){u.href=[c,e].join("")}}if(/Firefox/.test(navigator.userAgent)){setTimeout(f,0)}else{f()}})(screen,document,encodeURIComponent)})}},setPin:function(a){ShareButton.pin=a}};var PopupPicker={init:function(c,a,b){this.element=c;this.popup=a;this.attach();this.onPick=b.onPick;this.popup.addEventListener("click",function(f){var d=f.target;if(d.tagName.toLowerCase()!="li"){d=d.parentNode}if(d.tagName.toLowerCase()!="li"){return}this.onPick(d);this.hide()}.bind(this));return this},attach:function(){PopupPicker.element.addEventListener("click",PopupPicker.show)},detach:function(){PopupPicker.element.removeEventListener("click",PopupPicker.show)},show:function(){PopupPicker.detach();PopupPicker.popup.style.display="block";setTimeout(function(){document.body.addEventListener("click",PopupPicker.bodyClicked)},100)},hide:function(){PopupPicker.popup.style.display="none";document.body.removeEventListener("click",PopupPicker.bodyClicked);setTimeout(function(){PopupPicker.attach()},100)},bodyClicked:function(a){if(PopupPicker.popup.style.display!="none"&&!PopupPicker.isMouseOver(a)){PopupPicker.hide()}},isMouseOver:function(h){var a=h.pageX,i=h.pageY;var d=PopupPicker.popup.getBoundingClientRect();var g=d.left+PopupPicker.popup.clientLeft;var f=d.top+PopupPicker.popup.clientTop;var c=g+d.width;var b=f+d.height;return a>g&&a<c&&i>f&&i<b}};var BoardPicker={itemHeight:30,maxVisibleItems:8,setHeight:false,eventElement:document.createElement("div"),_h_boards:{},init:function(b,c){this.element=b;this._maxH=this.itemHeight*this.maxVisibleItems;this.curEl=b.querySelector(".name"),this.popEl=b.querySelector(".board-list"),this.bodyEl=b.querySelector(".board-list-body");this.listEl=this.bodyEl.querySelector("ul");this.bodyEl.style.height="0px";if(!this.popup){this.popup=PopupPicker.init(b,this.popEl,{onPick:this.select})}this._items=0;this.listEl.innerHTML="";if(c&&c.length>0){this.boards=c;var a={};c.forEach(function(d){BoardPicker._injectItem(d.board_id,d.title);a[d.board_id]=d});BoardPicker._h_boards=a;this.select(this.listEl.querySelector("li"))}else{this.curEl.innerHTML="选择画板...";this.curEl.data=null}return this},_injectItem:function(d,c){this._items+=1;var a=document.createElement("li");a.setAttribute("class","board-category");a.innerHTML="<span>"+c+"</span>";a.data=d;this.listEl.appendChild(a);var b=this._items*this.itemHeight;this.bodyEl.style.height=(b>this._maxH?this._maxH:b)+"px";return a},add:function(b){var a=this._injectItem(b.board_id,b.title);BoardPicker._h_boards[b.board_id]=b;this.select(a);return this},hide:function(){this.popup.hide()},select:function(a){if(!a){return}if(a.constructor===HTMLLIElement){BoardPicker.curEl.innerHTML=a.querySelector("span").innerHTML;BoardPicker.curEl.data=a.data;var e=BoardPicker._h_boards[a.data];BoardPicker.eventElement.dispatchEvent(new CustomEvent("select",{detail:e}));return BoardPicker}var c=BoardPicker.listEl.querySelectorAll("li");for(var d=0,b=c.length;d<b;d++){if(c[d].data==a){return BoardPicker.select(c[d])}}return BoardPicker},addEventListener:function(b,a){BoardPicker.eventElement.addEventListener(b,a)},getSelected:function(){return BoardPicker.curEl.data}};var UploadUI={init:function(a){if(a){Huaban.currentUserId=a.id}document.querySelector("#pin_wrapper .box-title .close").addEventListener("click",function(){UploadUI.closeDialog()});UploadUI.initSave();UploadUI.initBoards();ShareButton.init()},dataURItoBlobLink:function(e){var f=atob(e.split(",")[1]);var b=e.split(",")[0].split(":")[1].split(";")[0];var d=ajax.constructBlobData(f,b);var c=document.createElement("a");c.download="huaban.png";c.href=window.webkitURL.createObjectURL(d);c.dataset.downloadurl=[b,c.download,c.href].join(":");c.draggable=true;return c},initSave:function(){var a=$("btn_save");if(!a){return}a.addEventListener("click",function(){var c=photoshop.getDataUrl();var b=UploadUI.dataURItoBlobLink(c);b.click()})},showErrorInfo:function(a){$("msg").innerHTML=a;$("msg_bar").style.display="block";$("msg_bar").style.top=0;setTimeout(function(){UploadUI.hideErrorInfo()},HIDE_ERROR_INFO_DELAY_TIME)},hideErrorInfo:function(){var a=$("msg_bar").clientHeight+2;$("msg_bar").style.top="-"+a+"px"},getAccessToken:function(){var a=function(b,c){if(b=="success"){UploadUI.getUserInfo(c)}else{var d=null;if(c=="access_denied"||c=="invalid_grant"){d=c}if(d){d=chrome.i18n.getMessage(d)}else{d=c}UploadUI.showErrorInfo(d);UploadUI.showAuth()}};Huaban.getAccessToken(a)},getUserInfo:function(a){Huaban.getUserInfo(a,function(b,c,e){if(b=="success"){var d=a.id;if(!Huaban.getUser(d)){Huaban.currentUserId=d;Huaban.addUser(a);UploadUI.showUser(a);UploadUI.fillBoards(e)}}else{UploadUI.showErrorInfo(c)}})},getBoards:function(a){Huaban.getBoards(a,function(b,c){if(b=="success"){UploadUI.fillBoards(c)}else{UploadUI.signOut(a)}})},fillBoards:function(b){var a=document.querySelector("div.board-picker");BoardPicker.init(a,b)},initBoards:function(a){var b=document.querySelector("div.board-picker");var g=b.querySelector("div.create-board");var m=$("board_name_input");var e=g.querySelector("a.btn");var i=g.querySelector(".create-board-status");var c=document.querySelector("#pin_wrapper .rbtn");var h=8;var j=document.querySelector("textarea.description-textarea");var f=BoardPicker;var k=$$(".tag-tip")[0];var n=$$(".tag-prompt")[0];var l=n.querySelector(".tags");UploadUI.fillBoards(a);j.addEventListener("keyup",function(){var p=j.value;var o=l.querySelectorAll("a");o.forEach(function(r){var q=r.dataset.tag;q="#"+q+"#";if(!~p.indexOf(q)&&r.classList.contains("selected")){r.classList.remove("selected")}})});n.addEventListener("click",function(q){if(q.srcElement.tagName!="A"||!q.srcElement.dataset.tag){return}var p=q.srcElement;p.classList.add("selected");var o=p.dataset.tag;o="#"+o+"#";var r=j.value;if(~r.indexOf(o)){j.selectionStart=r.indexOf(o);j.selectionEnd=o.length+r.indexOf(o);return}j.value=r.trim()+" "+o});f.addEventListener("select",function(r){var q=r.detail;var s=q.recommend_tags||[];while(l.lastChild){l.lastChild.remove()}if(s.length){var p;for(var o=0;o<s.length;o+=1){p=document.createElement("a");p.textContent=s[o];p.setAttribute("title",s[o]);p.dataset.tag=s[o];l.appendChild(p)}n.style.display="block";k.style.display="none"}else{k.style.display="block";n.style.display="none"}});e.addEventListener("click",function(){var o=m.value||"";o=o.replace(/^\s+|\s+$/g,"");if(o==""){UploadUI.showErrorInfo("请输入名称");return false}e.classList.add("disabled");Huaban.createBoard(o,function(p,r){if(p=="success"&&r&&r.board){f.add(r.board).hide()}else{if(r.err&&r.fieldErrors){for(var q in r.fieldErrors){UploadUI.showErrorInfo(r.fieldErrors[q][0]);break}}else{if(r.err&&r.msg){UploadUI.showErrorInfo(r.msg)}else{UploadUI.showErrorInfo("网络错误，请稍候再试")}}}m.value=""})});c.addEventListener("click",function(){c.classList.add("disabled");var s=f.getSelected();if(!s){return alert("请选择画板")}var q=$("description").value;var p=document.querySelector("input.publish_to_weibo").checked;var o=$("url").value;var r=UploadUI.getImageData();c.innerText="采集中…";Huaban.upload(s,q,o,p,r,function(t,w,y){if(t=="success"){document.querySelector("#pin_wrapper .pbt").style.display="none";var x=w;var v=$("pin-done");var A=$("view_pin");A.href="http://"+DOMAIN+"/pins/"+x.pin_id;A.onclick=function(){chrome.tabs.create({url:A.href});return false};$("close_window").addEventListener("click",function(){window.close()});v.style.display="block";var z=v.querySelector("a.less");z.innerText=x.board.title;z.href="http://"+DOMAIN+"/boards/"+x.board_id;ShareButton.setPin(x);return}else{if(y&&y==413){UploadUI.showErrorInfo(chrome.i18n.getMessage("http_413"))}else{UploadUI.showErrorInfo(w)}}c.classList.remove("disabled");c.innerText="采下来"})});var d=function(){if(m.value!=""){e.classList.remove("disabled")}else{e.classList.add("disabled")}};m.addEventListener("keydown",d);m.addEventListener("focus",d);m.addEventListener("blur",d)},showUser:function(b){$("loading").style.display="none";$("authorization").style.display="none";document.querySelector(".pin-form").style.display="block";if(b&&b.bindings&&b.bindings.weibo){document.querySelector(".pin-form .buttons label.weibo").style.display="block"}else{document.querySelector(".pin-form .buttons label.weibo").style.display="none"}var f=$("user_icon");var c=document.createElement("a");c.href=Utils.getUserUrl(b);c.target="_blank";var a=new Image();if(b.avatar){a.src=Utils.getImgUrl(b.avatar,"sq75")}else{a.src="/images/default_buddy_icon.jpg"}var d=document.createElement("span");d.title=chrome.i18n.getMessage("remove_auth");d.addEventListener("click",function(){UploadUI.signOut(b)});var e=document.createTextNode(b.name);c.appendChild(a);c.appendChild(e);f.appendChild(c);f.appendChild(d);f.style.display="block"},signOut:function(a){var b=$("user_icon");b.innerHTML="";b.style.display="none";Huaban.removeUser(a.id);UploadUI.showAuth();return false},showAuth:function(){$("loading").style.display="none";$("authorization").style.display="block";document.querySelector(".pin-form").style.display="none"},showLoading:function(){$("loading").style.display="block";$("authorization").style.display="none";document.querySelector(".pin-form").style.display="none"},getImageData:function(){var b=photoshop.getDataUrl();var a=b.indexOf("data:image/png;base64,");if(a!=0){return}return atob(b.substr(a+22))},showDialog:function(){var a=$("overlay");a.style.width=document.body.scrollWidth+"px";a.style.height=document.body.scrollHeight+"px";a.style.display="block";$("pin_wrapper").style.display="block"},closeDialog:function(){var a=$("overlay");a.style.width=document.body.scrollWidth+"px";a.style.height=document.body.scrollHeight+"px";a.style.display="none";$("pin_wrapper").style.display="none"}};(function(){var a;chrome.tabs.query({active:true,currentWindow:true},function(b){a=b[0].id});chrome.runtime.onMessage.addListener(function(d,c){switch(d.msg){case"url_for_access_token":var b=d.url;if(Huaban.isRedirectUrl(b)){chrome.tabs.update(a,{selected:true});chrome.tabs.remove(c.tab.id);Huaban.parseAccessToken(b)}break}})})();