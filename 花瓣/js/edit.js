"use strict";var bg=chrome.extension.getBackgroundPage();var Canvas=(function(){var a=function(e,f){var h=e.toLowerCase();var d=[];for(var g=1;g<h.length;g+=2){d.push(parseInt("0x"+h.slice(g,g+2)))}return"rgba("+d.join(",")+","+f+")"};var b=function(f,g,e,d,i,h){var k=function(){var l=e-i;var p=d-h;var o=Math.sqrt(l*l+p*p);o=(o==0?g:o);var n=Math.round(l/o*g);var m=Math.round(p/o*g);return{x:i+n,y:h+m}};var j=function(p,r){var l=p.x-e;var q=p.y-d;var o=Math.sqrt(l*l+q*q);o=(o==0?g:o);var n=Math.round((q/o*f)*r);var m=Math.round((l/o*f)*r);return{x:p.x+n,y:p.y-m}};return{p1:j(k(),1),p2:j(k(),-1)}};var c=function(g){g=g||"";g=g.split(", ");var d=[];for(var j=0,f=g.length;j<f;j++){var i=g[j].split(" ");var e=i[0].replace(parseFloat(i[0]),"");if(e=="em"){var h={x:metrics.em*parseFloat(i[0]),y:metrics.em*parseFloat(i[1])}}else{var h={x:parseFloat(i[0]),y:parseFloat(i[1])}}if(i[3]){h.blur=parseFloat(i[2]);h.color=i[3]}else{h.blur=0;h.color=i[2]}d.push(h)}return d};return{drawStrokeRect:function(g,h,f,j,i,e,d){g.strokeStyle=h;g.lineWidth=d;g.strokeRect(f,j,i,e)},drawFillRect:function(f,g,e,i,h,d){f.fillStyle=g;f.fillRect(e,i,h,d)},drawEllipse:function(p,g,o,n,e,d,l,m){var k=o+e;var j=n;p.beginPath();p.lineWidth=l;p.moveTo(k,j);for(var h=0;h<=360;h++){var f=h*Math.PI/180;k=o+(e-2)*Math.cos(f);j=n-(d-2)*Math.sin(f);p.lineTo(k,j)}if(m=="rect"){p.fillStyle=a(g,0.5);p.fill()}else{if(m=="border"){p.strokeStyle=g;p.stroke()}}p.closePath()},getLines:function(o,n,f,g){var l=n.split(" ");var p=[];var m="";var e=0;o.font=g;for(var k=0;k<l.length;k++){var d=l[k];e=o.measureText(m+d).width;if(e<=f||d==""){m+=d+" "}else{if(m!=""){p.push(m)}e=o.measureText(d).width;if(e<=f){m=d+" "}else{m=d[0];for(var h=1;h<d.length;h++){e=o.measureText(m+d[h]).width;if(e<=f){m+=d[h]}else{p.push(m);m=d[h]}}m+=" "}}}if(m!=""){p.push(m)}return p},setText:function(o,n,e,q,h,l,k,j,d,m){o.textBaseline="top";o.fillStyle=e;o.font=q+" "+h;o.lineHeight=l;var p=Canvas.prototype.getLines(o,n,d-2,o.font);var f=c(m);var m;if(f.length>0){m=f[0]}o.save();o.beginPath();for(var g=0;g<p.length;g++){if(m&&m.blur){o.shadowColor=m.color;o.shadowOffsetX=m.x;o.shadowOffsetY=m.y;o.shadowBlur=m.blur}o.fillText(p[g],k,j+l*g,d)}o.restore()},drawLine:function(g,h,k,e,f,d,j,i){g.beginPath();g.moveTo(f,d);g.strokeStyle=h;g.lineWidth=e;g.lineCap=k;g.lineTo(j,i);g.closePath();g.stroke()},drawArrow:function(n,e,j,g,f,m,i,h,l,k){var d=b(g,f,i,h,l,k);n.beginPath();n.strokeStyle=e;n.lineWidth=j;n.lineCap=m;n.moveTo(i,h);n.lineTo(l,k);n.lineTo(d.p1.x,d.p1.y);n.moveTo(l,k);n.lineTo(d.p2.x,d.p2.y);n.closePath();n.stroke()},drawRoundedRect:function(g,h,f,k,j,e,d,i){g.beginPath();g.moveTo(f,k+d);g.lineTo(f,k+e-d);g.quadraticCurveTo(f,k+e,f+d,k+e);g.lineTo(f+j-d,k+e);g.quadraticCurveTo(f+j,k+e,f+j,k+e-d);g.lineTo(f+j,k+d);g.quadraticCurveTo(f+j,k,f+j-d,k);g.lineTo(f+d,k);g.quadraticCurveTo(f,k,f,k+d);if(i=="rect"){g.fillStyle=a(h,0.5);g.fill()}else{if(i=="border"){g.strokeStyle=h;g.lineWidth=2;g.stroke()}}g.closePath()},blurImage:function(n,l,f,h,g,q,o){var k=h<q?h:q;var j=g<o?g:o;var e=Math.abs(q-h-1);var m=Math.abs(o-g-1);l.width=$(f).clientWidth+10;l.height=$(f).clientHeight+10;var p=l.getContext("2d");try{p.drawImage(n,k,j,e,m,0,0,e,m)}catch(i){console.log(i+" width : height"+e+" : "+m)}var d=p.getImageData(0,0,e,m);d=this.boxBlur(d,e,m,10);p.putImageData(d,0,0)},boxBlur:function(g,d,u,r){var n;var t=g.data;var w=0;var v=0;var e=0;var l;var q;var s;for(l=0;l<2;l++){if(l){v=d;w=u;e=d*4}else{v=u;w=d;e=4}for(var o=0;o<v;o++){q=(l==0?(o*d*4):(4*o));for(var h=0;h<4;h++){s=q+h;var p=0;for(var f=0;f<r;f++){p+=t[s+e*f]}t[s]=t[s+e]=t[s+e*2]=Math.floor(p/r);for(n=3;n<w-2;n++){p=Math.max(0,p-t[s+(n-2)*e]+t[s+(n+2)*e]);t[s+n*e]=Math.floor(p/r)}t[s+n*e]=t[s+(n+1)*e]=Math.floor(p/r)}}}return g}}}());var photoshop={canvas:document.createElement("canvas"),tabTitle:"",startX:0,startY:0,endX:0,endY:0,dragFlag:false,flag:"rectangle",layerId:"layer0",canvasId:"",color:"#ff0000",lastValidAction:0,markedArea:[],isDraw:true,isCropTurnOn:false,nowHeight:0,nowWidth:0,highlightType:"border",highlightMode:"rectangle",text:"","text-shadow":"1px 1px 8px #000",actions:[],i18nReplace:Utils.i18nReplace,setUnfilled:function(){var a=$("photo");if(a.offsetLeft>0){a.className="unfilled"}else{a.classList.remove("unfilled")}},markCurrentElement:function(c){if(c&&c.parentNode){var b=c.parentNode.children;for(var a=0;a<b.length;a++){var d=b[a];if(d==c){c.className="mark"}else{d.className=""}}}},setHighLightMode:function(){photoshop.highlightType=localStorage.highlightType||"border";$(photoshop.layerId).style.border="2px solid "+photoshop.color;if(photoshop.highlightType=="rect"){$(photoshop.layerId).style.backgroundColor=photoshop.color;$(photoshop.layerId).style.opacity=0.5}if(photoshop.flag=="rectangle"){$(photoshop.layerId).style.borderRadius="0 0"}else{if(photoshop.flag=="radiusRectangle"){$(photoshop.layerId).style.borderRadius="6px 6px"}else{if(photoshop.flag=="ellipse"){$(photoshop.layerId).style.border="0";$(photoshop.layerId).style.backgroundColor="";$(photoshop.layerId).style.opacity=1}}}},setBlackoutMode:function(){photoshop.color="#000000";$(photoshop.layerId).style.opacity=1;$(photoshop.layerId).style.backgroundColor="#000000";$(photoshop.layerId).style.border="2px solid #000000"},setTextMode:function(){localStorage.fontSize=localStorage.fontSize||"14";photoshop.color=localStorage.color;$(photoshop.layerId).setAttribute("contentEditable",true);$(photoshop.layerId).style.border="1px dotted #333333";$(photoshop.layerId).style.cursor="text";$(photoshop.layerId).style.lineHeight=localStorage.fontSize+"px";$(photoshop.layerId).style.fontSize=localStorage.fontSize+"px";$(photoshop.layerId).style.color=photoshop.color;$(photoshop.layerId).style["text-shadow"]=photoshop["text-shadow"];$(photoshop.layerId).innerHTML="<br/>";var a=$(photoshop.layerId);a.addEventListener("blur",function(){photoshop.setTextToArray("layer"+(photoshop.lastValidAction-1))});a.addEventListener("click",function(){this.style.border="1px dotted #333333"},true);a.addEventListener("mouseout",function(){if(!photoshop.dragFlag){this.style.borderWidth=0}},false);a.addEventListener("mousemove",function(){this.style.border="1px dotted #333333"},false)},setTextToArray:function(c){var b=$(c).innerText.split("\n");if(photoshop.markedArea.length>0){for(var a=photoshop.markedArea.length-1;a>=0;a--){if(photoshop.markedArea[a].id==c){photoshop.markedArea[a].context=b;break}}$(c).style.borderWidth=0}},finish:function(){var a=$("canvas").getContext("2d");a.drawImage(photoshop.canvas,0,0)},colorRgba:function(b,c){var e=b.toLowerCase();var a=[];for(var d=1;d<e.length;d+=2){a.push(parseInt("0x"+e.slice(d,d+2)))}return"rgba("+a.join(",")+","+c+")"},toDo:function(a,b){if(photoshop.flag==="crop"){photoshop.removeCropArea()}photoshop.flag=b;photoshop.isDraw=true;photoshop.markCurrentElement(a)},setDivStyle:function(a,b){$(photoshop.layerId).setAttribute("style","");$(photoshop.layerId).setAttribute("contentEditable",false);switch(photoshop.flag){case"rectangle":case"radiusRectangle":case"ellipse":photoshop.setHighLightMode();break;case"redact":photoshop.setBlackoutMode();break;case"text":photoshop.setTextMode();break;case"line":case"arrow":photoshop.drawLineOnMaskCanvas(a,b,a,b,"lineStart",photoshop.layerId);break;case"blur":photoshop.createCanvas(photoshop.layerId);break}},createDiv:function(c,d,b){var a=document.createElement("div");a.id=d;if(b){a.className=b}c.appendChild(a);return a},createCanvas:function(b){photoshop.canvasId="cav-"+b;if(!$(photoshop.canvasId)){var a=document.createElement("canvas");a.id=photoshop.canvasId;a.width=10;a.height=10;$(photoshop.layerId).appendChild(a);return a}return $(photoshop.canvasId)},createLayer:function(){photoshop.lastValidAction++;photoshop.layerId="layer"+photoshop.lastValidAction;if($(photoshop.layerId)){photoshop.removeElement(photoshop.layerId)}var a=document.createElement("div");a.id=photoshop.layerId;a.className="layer";$("photo").appendChild(a);if(photoshop.flag=="blur"){photoshop.createCanvas(photoshop.layerId)}return a},removeLayer:function(b){for(var a=0;a<photoshop.markedArea.length;a++){if(photoshop.markedArea[a].id==b){photoshop.markedArea.splice(a,1);break}}photoshop.removeElement(b)},createCropArea:function(){photoshop.marginLeft=$("photo").offsetLeft;photoshop.marginTop=$("photo").offsetTop;var d=$("crop_wrapper");d.style.width=photoshop.canvas.width+"px";d.style.height=photoshop.canvas.height+"px";d.style.display="block";d.addEventListener("mousedown",photoshop.cropMouseDown,false);photoshop.createDiv(d,"dragshadow_t","dragshadow");photoshop.createDiv(d,"dragshadow_b","dragshadow");photoshop.createDiv(d,"dragshadow_l","dragshadow");photoshop.createDiv(d,"dragshadow_r","dragshadow");var e=photoshop.createDiv(d,"crop_container");var b=photoshop.createDiv(e,"crop_boundary");photoshop.createDiv(e,"drag_size");photoshop.createDiv(b,"dragline_t","dragline");photoshop.createDiv(b,"dragline_d","dragline");photoshop.createDiv(b,"dragline_l","dragline");photoshop.createDiv(b,"dragline_r","dragline");var c=photoshop.createDiv(e,"drag_cancel");c.innerHTML=chrome.i18n.getMessage("cancel");c.addEventListener("mousedown",function(f){photoshop.removeCropArea();photoshop.createCropArea();f.stopPropagation()},false);var a=photoshop.createDiv(e,"drag_crop");a.innerHTML=chrome.i18n.getMessage("ok");a.addEventListener("mousedown",function(f){photoshop.crop();f.stopPropagation()},false)},removeChildrenEls:function(b){var a=document.getElementById(b);while(a.firstChild){a.removeChild(a.firstChild)}},removeCropArea:function(){$("crop_container").removeEventListener("dblclick",function(){photoshop.crop()});photoshop.removeChildrenEls("crop_wrapper");photoshop.isCropTurnOn=false},updateShadow:function(f,e,d,b){$("dragshadow_t").style.height=e+"px";$("dragshadow_t").style.width=f+d+"px";$("dragshadow_l").style.height=photoshop.canvas.height-e+"px";$("dragshadow_l").style.width=f+"px";var c=e+b;c=c>0?c:0;var a=photoshop.canvas.width-f-d;a=a>0?a:0;$("dragshadow_r").style.height=c+"px";$("dragshadow_r").style.width=a+"px";c=photoshop.canvas.height-e-b;c=c>0?c:0;a=photoshop.canvas.width-f;a=a>0?a:0;$("dragshadow_b").style.height=c+"px";$("dragshadow_b").style.width=a+"px"},updateArea:function(e,d,b,a){var c=$("crop_container");c.style.left=e+"px";c.style.top=d+"px";c.style.width=Math.abs(b)+"px";c.style.height=Math.abs(a)+"px"},updateSize:function(b,a){$("drag_size").innerText=b+" x "+a},cropMouseDown:function(f){if(f.button==0&&photoshop.flag==="crop"){var c=function(l){var i=l.pageX-b;var j=l.pageY-a;var k=photoshop.startX=(i>0)?b:b+i;var m=photoshop.startY=(j>0)?a:a+j;k-=photoshop.marginLeft;m-=photoshop.marginTop;i=Math.abs(i);j=Math.abs(j);photoshop.updateShadow(k,m,i,j);photoshop.updateArea(k,m,i,j);photoshop.updateSize(i,j);photoshop.endX=photoshop.startX+i;photoshop.endY=photoshop.startY+j;l.stopPropagation()};var d=function(j){if((j.pageX-b==0||j.pageY-a==0)&&$("crop_container").offsetWidth==0){var i=photoshop.startX=b-h/2;var l=photoshop.startY=a-h/2;i-=photoshop.marginLeft;l-=photoshop.marginTop;photoshop.updateShadow(i,l,h,h);photoshop.updateArea(i,l,h,h);photoshop.updateSize(h,h);photoshop.endX=photoshop.startX+h;photoshop.endY=photoshop.startY+h}e.removeEventListener("mousedown",photoshop.cropMouseDown,false);e.removeEventListener("mousemove",c,false);e.removeEventListener("mouseup",d,false);var k=$("photo");if(photoshop.endY+25>k.offsetTop+k.clientHeight){$("drag_crop").style.bottom="3px";$("drag_cancel").style.bottom="3px"}else{$("drag_crop").style.bottom="-28px";$("drag_cancel").style.bottom="-28px"}if(photoshop.startY-22<k.offsetTop){$("drag_size").style.top="3px"}else{$("drag_size").style.top="-22px"}$("drag_size").style.display="block";$("drag_cancel").style.display="block";$("drag_crop").style.display="block";photoshop.createDiv(g,"dragdot_tl","dragdot").setAttribute("data-direct","tl");photoshop.createDiv(g,"dragdot_tr","dragdot").setAttribute("data-direct","tr");photoshop.createDiv(g,"dragdot_br","dragdot").setAttribute("data-direct","br");photoshop.createDiv(g,"dragdot_bl","dragdot").setAttribute("data-direct","bl");photoshop.createDiv(g,"dragdot_mt","dragdot").setAttribute("data-direct","mt");photoshop.createDiv(g,"dragdot_mr","dragdot").setAttribute("data-direct","mr");photoshop.createDiv(g,"dragdot_mb","dragdot").setAttribute("data-direct","mb");photoshop.createDiv(g,"dragdot_ml","dragdot").setAttribute("data-direct","ml");photoshop.createDiv(g,"dragbar_t","dragbar").setAttribute("data-direct","mt");photoshop.createDiv(g,"dragbar_r","dragbar").setAttribute("data-direct","mr");photoshop.createDiv(g,"dragbar_b","dragbar").setAttribute("data-direct","mb");photoshop.createDiv(g,"dragbar_l","dragbar").setAttribute("data-direct","ml");$("crop_boundary").addEventListener("dblclick",function(){photoshop.crop()},false);photoshop.isCropTurnOn=true;j.stopPropagation()};var h=200;var b=f.pageX;var a=f.pageY;var e=$("crop_wrapper");var g=$("crop_container");photoshop.updateShadow(b,a,0,0);e.addEventListener("mousemove",c,false);e.addEventListener("mouseup",d,false);f.stopPropagation()}},cropDragMouseDown:function(a){a.stopPropagation();var e=a.target;if(e){var i=e.tagName;if(i&&document){photoshop.isMouseDown=true;var h=$("crop_container");var c=a.pageX;var f=a.pageY;var d=photoshop.direct=e.getAttribute("data-direct");if(h){var g=h.offsetLeft+photoshop.marginLeft;var b=h.offsetTop+photoshop.marginTop;if(e==$("crop_boundary")){photoshop.moving=true;photoshop.moveX=c-h.offsetLeft;photoshop.moveY=f-h.offsetTop}else{if(d=="tr"){photoshop.resizing=true;photoshop.startX=g;photoshop.startY=b+h.clientHeight}else{if(d=="tl"){photoshop.resizing=true;photoshop.startX=g+h.clientWidth;photoshop.startY=b+h.clientHeight}else{if(d=="br"){photoshop.resizing=true;photoshop.startX=g;photoshop.startY=b}else{if(d=="bl"){photoshop.resizing=true;photoshop.startX=g+h.clientWidth;photoshop.startY=b}else{if(d=="mt"){photoshop.resizing=true;photoshop.startY=b+h.clientHeight}else{if(d=="mr"){photoshop.resizing=true;photoshop.startX=g}else{if(d=="mb"){photoshop.resizing=true;photoshop.startY=b}else{if(d=="ml"){photoshop.resizing=true;photoshop.startX=g+h.clientWidth}else{photoshop.dragging=true;photoshop.endX=photoshop.startX=c;photoshop.endY=photoshop.startY=f}}}}}}}}}}a.preventDefault()}}},cropDragMouseMove:function(b){b.stopPropagation();var h=b.target;if(h&&photoshop.isMouseDown){var l=$("crop_container");if(l){var d=b.pageX;var k=b.pageY;var f=0;var g=0;var o;var n;var m=photoshop.direct||null;if(photoshop.dragging||photoshop.resizing){var j=document.body.clientWidth;var e=document.body.clientHeight;if(d>j){d=j}else{if(d<0){d=0}}if(k>e){k=e}else{if(k<0){k=0}}if(photoshop.dragging||(photoshop.resizing&&["tr","tl","br","bl"].indexOf(m)!=-1)){f=d-photoshop.startX;g=k-photoshop.startY;o=f>0?photoshop.startX:d;n=g>0?photoshop.startY:k;f=Math.abs(f);g=Math.abs(g);photoshop.endX=d;photoshop.endY=k}else{if(photoshop.resizing&&["mt","mr","mb","ml"].indexOf(m)!=-1){if(m=="mt"||m=="mb"){g=k-photoshop.startY;o=photoshop.startX;n=g>0?photoshop.startY:k;f=photoshop.endX-photoshop.startX;g=Math.abs(g);photoshop.endY=k}else{if(m=="mr"||m=="ml"){f=d-photoshop.startX;o=f>0?photoshop.startX:d;n=photoshop.startY;f=Math.abs(f);g=photoshop.endY-photoshop.startY;photoshop.endX=d}}}}o-=photoshop.marginLeft;n-=photoshop.marginTop;photoshop.updateShadow(o,n,f,g);photoshop.updateArea(o,n,f,g);photoshop.updateSize(f,g);if(window.innerWidth<d){document.body.scrollLeft=d-window.innerWidth}if(document.body.scrollTop+window.innerHeight<k+25){document.body.scrollTop=k-window.innerHeight+25}if(k<document.body.scrollTop){document.body.scrollTop-=25}}else{if(photoshop.moving){f=l.clientWidth;g=l.clientHeight;var a=d-photoshop.moveX;var i=k-photoshop.moveY;if(a<0){a=0}else{if(a+f>photoshop.canvas.width){a=photoshop.canvas.width-f}}if(i<0){i=0}else{if(i+g>photoshop.canvas.height){i=photoshop.canvas.height-g}}n=i;photoshop.updateShadow(a,i,f,g);photoshop.updateArea(a,i,f,g);a+=photoshop.marginLeft;i+=photoshop.marginTop;photoshop.startX=a;photoshop.endX=a+f;photoshop.startY=i;photoshop.endY=i+g}}var c=$("photo");if(n+g+25>c.clientHeight){$("drag_crop").style.bottom="3px";$("drag_cancel").style.bottom="3px"}else{$("drag_crop").style.bottom="-28px";$("drag_cancel").style.bottom="-28px"}if(n<22){$("drag_size").style.top="3px"}else{$("drag_size").style.top="-22px"}}}},cropDragMouseUp:function(b){b.stopPropagation();photoshop.isMouseDown=false;if(b.button!=2){photoshop.resizing=false;photoshop.dragging=false;photoshop.moving=false;photoshop.moveX=0;photoshop.moveY=0;var a;if(photoshop.endX<photoshop.startX){a=photoshop.endX;photoshop.endX=photoshop.startX;photoshop.startX=a}if(photoshop.endY<photoshop.startY){a=photoshop.endY;photoshop.endY=photoshop.startY;photoshop.startY=a}}},onMouseDown:function(a){if(photoshop.flag==="crop"){if(photoshop.isCropTurnOn){photoshop.cropDragMouseDown(a)}return}if(photoshop.isDraw&&a.button!=2){photoshop.startX=a.pageX-$("photo").offsetLeft;photoshop.startY=a.pageY-$("photo").offsetTop;photoshop.setDivStyle(photoshop.startX,photoshop.startY);photoshop.dragFlag=true;$(photoshop.layerId).style.left=photoshop.startX+"px";$(photoshop.layerId).style.top=photoshop.startY+"px";$(photoshop.layerId).style.height=0;$(photoshop.layerId).style.width=0;$(photoshop.layerId).style.display="block"}},onMouseMove:function(a){if(photoshop.flag==="crop"){if(photoshop.isCropTurnOn){photoshop.cropDragMouseMove(a)}return}if(photoshop.dragFlag){$("mask_canvas").style.zIndex=200;photoshop.endX=a.pageX-$("photo").offsetLeft;if(photoshop.endX>photoshop.canvas.width){photoshop.endX=photoshop.canvas.width}if(photoshop.endX<0){photoshop.endX=0}photoshop.endY=a.pageY-$("photo").offsetTop;if(photoshop.endY>photoshop.canvas.height){photoshop.endY=photoshop.canvas.height}if(photoshop.endY<0){photoshop.endY=0}photoshop.nowHeight=photoshop.endY-photoshop.startY-1;photoshop.nowWidth=photoshop.endX-photoshop.startX-1;if(photoshop.nowHeight<0){$(photoshop.layerId).style.top=photoshop.endY+"px";photoshop.nowHeight=-1*photoshop.nowHeight}if(photoshop.nowWidth<0){$(photoshop.layerId).style.left=photoshop.endX+"px";photoshop.nowWidth=-1*photoshop.nowWidth}$(photoshop.layerId).style.height=photoshop.nowHeight-3+"px";$(photoshop.layerId).style.width=photoshop.nowWidth-3+"px";if(photoshop.flag=="line"||photoshop.flag=="arrow"){photoshop.drawLineOnMaskCanvas(photoshop.startX,photoshop.startY,photoshop.endX,photoshop.endY,"lineDrawing",photoshop.layerId)}else{if(photoshop.flag=="blur"){$(photoshop.layerId).style.height=photoshop.nowHeight+"px";$(photoshop.layerId).style.width=photoshop.nowWidth+"px";Canvas.blurImage(photoshop.canvas,$(photoshop.canvasId),photoshop.layerId,photoshop.startX,photoshop.startY,photoshop.endX,photoshop.endY)}else{if(photoshop.flag=="ellipse"){photoshop.drawEllipseOnMaskCanvas(photoshop.endX,photoshop.endY,"drawing",photoshop.layerId)}}}}a.stopPropagation()},onMouseUp:function(a){if(photoshop.flag==="crop"){if(photoshop.isCropTurnOn){photoshop.cropDragMouseUp(a)}return}$("mask_canvas").style.zIndex=10;photoshop.endX=a.pageX-$("photo").offsetLeft;if(photoshop.endX>photoshop.canvas.width){photoshop.endX=photoshop.canvas.width}if(photoshop.endX<0){photoshop.endX=0}photoshop.endY=a.pageY-$("photo").offsetTop;if(photoshop.endY>photoshop.canvas.height){photoshop.endY=photoshop.canvas.height}if(photoshop.endY<0){photoshop.endY=0}if(photoshop.isDraw&&photoshop.dragFlag&&(photoshop.endX!=photoshop.startX||photoshop.endY!=photoshop.startY)){if(photoshop.flag=="line"||photoshop.flag=="arrow"){photoshop.drawLineOnMaskCanvas(photoshop.startX,photoshop.startY,photoshop.endX,photoshop.endY,"drawEnd",photoshop.layerId)}else{if(photoshop.flag=="blur"){Canvas.blurImage(photoshop.canvas,$(photoshop.canvasId),photoshop.layerId,photoshop.startX,photoshop.startY,photoshop.endX,photoshop.endY)}else{if(photoshop.flag=="ellipse"){photoshop.drawEllipseOnMaskCanvas(photoshop.endX,photoshop.endY,"end",photoshop.layerId)}}}photoshop.enableUndo();photoshop.saveAction({type:"draw"},{id:photoshop.layerId});photoshop.markedArea.push({id:photoshop.layerId,startX:photoshop.startX,startY:photoshop.startY,endX:photoshop.endX,endY:photoshop.endY,width:photoshop.nowWidth,height:photoshop.nowHeight,flag:photoshop.flag,highlightType:photoshop.highlightType,fontSize:localStorage.fontSize,color:photoshop.color,context:"","text-shadow":photoshop["text-shadow"]});$(photoshop.layerId).focus();photoshop.createLayer()}else{if(photoshop.endX==photoshop.startX&&photoshop.endY==photoshop.startY){photoshop.removeElement(photoshop.layerId);photoshop.createLayer()}}photoshop.dragFlag=false;a.stopPropagation()},removeElement:function(a){if($(a)){$(a).parentNode.removeChild($(a))}},draw:function(){var d=$("canvas").getContext("2d");for(var h=0;h<photoshop.markedArea.length;h++){var f=photoshop.markedArea[h];var m=(f.startX<f.endX)?f.startX:f.endX;var l=(f.startY<f.endY)?f.startY:f.endY;var c=f.width;var n=f.height;var g=f.color;switch(f.flag){case"rectangle":if(f.highlightType=="border"){Canvas.drawStrokeRect(d,g,m,l,c,n,2)}else{var g=changeColorToRgba(g,0.5);Canvas.drawFillRect(d,g,m,l,c,n)}break;case"radiusRectangle":Canvas.drawRoundedRect(d,g,m,l,c,n,6,f.highlightType);break;case"ellipse":m=(f.startX+f.endX)/2;l=(f.startY+f.endY)/2;var e=Math.abs(f.endX-f.startX)/2;var b=Math.abs(f.endY-f.startY)/2;Canvas.drawEllipse(d,g,m,l,e,b,3,f.highlightType);break;case"redact":Canvas.drawFillRect(d,g,m,l,c,n);break;case"text":for(var k=0;k<f.context.length;k++){Canvas.setText(d,f.context[k],g,f.fontSize+"px","arial",f.fontSize,m,l+f.fontSize*k,c,f["text-shadow"])}break;case"blur":var a=d.getImageData(m,l,photoshop.markedArea[h].width,photoshop.markedArea[h].height);a=Canvas.boxBlur(a,photoshop.markedArea[h].width,photoshop.markedArea[h].height,10);d.putImageData(a,m,l,0,0,photoshop.markedArea[h].width,photoshop.markedArea[h].height);break;case"line":Canvas.drawLine(d,g,"round",2,f.startX,f.startY,f.endX,f.endY);break;case"arrow":Canvas.drawArrow(d,g,2,4,10,"round",f.startX,f.startY,f.endX,f.endY);break}}},crop:function(){var g=$("crop_container");var j=parseInt(g.style.left);var h=parseInt(g.style.top);var d=parseInt(g.style.width);var e=parseInt(g.style.height);var a=$("canvas").getContext("2d");var b=a.getImageData(j,h,d,e);var c=$$(".layer");c=Array.prototype.slice.call(c,0,c.length-1);for(var f=c.length-1;f>=0;f--){c[f].style.left=parseInt(c[f].style.left)-j+"px";c[f].style.top=parseInt(c[f].style.top)-h+"px";photoshop.markedArea[f].startX-=j;photoshop.markedArea[f].endX-=j;photoshop.markedArea[f].startY-=h;photoshop.markedArea[f].endY-=h}photoshop.enableUndo();photoshop.saveAction({type:"crop"},{width:photoshop.canvas.width,height:photoshop.canvas.height,layers:c,offsetTop:h,offsetLeft:j});$("canvas").width=$("mask_canvas").width=photoshop.canvas.width=d;$("photo").style.width=d+"px";$("canvas").height=$("mask_canvas").height=photoshop.canvas.height=e;$("photo").style.height=e+"px";photoshop.setUnfilled();a.putImageData(b,0,0);a=photoshop.canvas.getContext("2d");a.putImageData(b,0,0);photoshop.removeCropArea();photoshop.createCropArea()},undo:function(){var b=function(){$("canvas").width=$("mask_canvas").width=photoshop.canvas.width=c.width;$("photo").style.width=c.width+"px";$("canvas").height=$("mask_canvas").height=photoshop.canvas.height=c.height;$("photo").style.height=c.height+"px";photoshop.setUnfilled();var h=c.data;$("canvas").getContext("2d").putImageData(h,0,0);photoshop.canvas.getContext("2d").putImageData(h,0,0);photoshop.marginLeft=$("photo").offsetLeft;photoshop.marginTop=$("photo").offsetTop;var j=$("crop_wrapper");j.style.width=c.width+"px";j.style.height=c.height+"px";var g=c.layers;var f=c.offsetTop;var e=c.offsetLeft;for(var d=g.length-1;d>=0;d--){g[d].style.left=parseInt(g[d].style.left)+e+"px";g[d].style.top=parseInt(g[d].style.top)+f+"px";photoshop.markedArea[d].startX+=e;photoshop.markedArea[d].endX+=e;photoshop.markedArea[d].startY+=f;photoshop.markedArea[d].endY+=f}c=null};var a=photoshop.actions.length;var c=photoshop.actions.pop();if(a==0){return}if(a==1){photoshop.disableUndo()}switch(c.type){case"draw":photoshop.removeLayer(c.id);break;case"crop":b();break}},enableUndo:function(){$("btn_undo").className=""},disableUndo:function(){$("btn_undo").className="disable"},saveAction:function(e,b){var d=$("canvas").getContext("2d");switch(e.type){case"draw":photoshop.actions.push({type:"draw",id:b.id});break;case"crop":var a=b.width;var c=b.height;photoshop.actions.push({type:"crop",data:d.getImageData(0,0,a,c),width:a,height:c,layers:b.layers,offsetTop:b.offsetTop,offsetLeft:b.offsetLeft});break}},getDataUrl:function(){photoshop.draw();var a=localStorage.screenshootQuality||"png";var b;if(a=="jpeg"&&isHighVersion()){b=$("canvas").toDataURL("image/jpeg",0.5)}else{b=$("canvas").toDataURL("image/png")}photoshop.finish();return b},drawLineOnMaskCanvas:function(g,f,l,k,i,e){var m=$("mask_canvas").getContext("2d");m.clearRect(0,0,$("mask_canvas").width,$("mask_canvas").height);if(i=="drawEnd"){var d=20;var a=Math.abs(l-photoshop.startX)>0?Math.abs(l-photoshop.startX):0;var j=Math.abs(k-photoshop.startY)>0?Math.abs(k-photoshop.startY):0;var c=parseInt($(e).style.left);var b=parseInt($(e).style.top);g=g-c+d/2;f=f-b+d/2;l=l-c+d/2;k=k-b+d/2;$(e).style.left=c-d/2+"px";$(e).style.top=b-d/2+"px";var h=photoshop.createCanvas(e);h.width=a+d;h.height=j+d;m=h.getContext("2d")}if(localStorage.lineType=="line"){Canvas.drawLine(m,localStorage.color,"round",2,g,f,l,k)}else{Canvas.drawArrow(m,localStorage.color,2,4,10,"round",g,f,l,k)}},drawEllipseOnMaskCanvas:function(p,o,l,f){var q=$("mask_canvas").getContext("2d");q.clearRect(0,0,$("mask_canvas").width,$("mask_canvas").height);var n=(photoshop.startX+p)/2;var m=(photoshop.startY+o)/2;var c=Math.abs(p-photoshop.startX)/2;var a=Math.abs(o-photoshop.startY)/2;Canvas.drawEllipse(q,photoshop.color,n,m,c,a,3,photoshop.highlightType);if(l=="end"){var d=parseInt($(f).style.left);var b=parseInt($(f).style.top);var i=photoshop.startX-d;var g=photoshop.startY-b;var j=photoshop.endX-d;var h=photoshop.endY-b;n=(i+j)/2;m=(g+h)/2;c=Math.abs(j-i)/2;a=Math.abs(h-g)/2;var k=photoshop.createCanvas(f);k.width=Math.abs(p-photoshop.startX);k.height=Math.abs(o-photoshop.startY);var e=k.getContext("2d");Canvas.drawEllipse(e,photoshop.color,n,m,c,a,3,photoshop.highlightType);q.clearRect(0,0,$("mask_canvas").width,$("mask_canvas").height)}},createColorPadEl:function(d){var c=["#000000","#0036ff","#008000","#dacb23","#d56400","#c70000","#be00b3","#1e2188","#0090ff","#22cc01","#ffff00","#ff9600","#ff0000","#ff008e","#7072c3","#49d2ff","#9dff3d","#ffffff","#ffbb59","#ff6b6b","#ff6bbd"];var e=document.createElement("div");e.id="colorpad";for(var b=0;b<c.length;b++){var a=c[b];c[b]=document.createElement("a");c[b].setAttribute("title",a);c[b].style.backgroundColor=a;c[b].addEventListener("click",function(h){var g=h.target;var f=g.title;photoshop.colorPadPick(f,d)});e.appendChild(c[b])}return e},colorPadPick:function(a,b){photoshop.color=a;localStorage.color=a;$("color_box").style.background=a},setFontSize:function(a){var b="size_"+a;localStorage.fontSize=a;$("size_10").className="";$("size_14").className="";$("size_18").className="";$("size_32").className="";$(b).className="mark"},initTools:function(){photoshop.i18nReplace("t_undo","undo");photoshop.i18nReplace("t_crop","crop");photoshop.i18nReplace("t_rectangle","rect");photoshop.i18nReplace("t_radius_rectangle","radius_rect");photoshop.i18nReplace("t_ellipse","ellipse");photoshop.i18nReplace("t_line","line");photoshop.i18nReplace("t_arrow","arrow");photoshop.i18nReplace("t_blur","blur");photoshop.i18nReplace("t_text","text");photoshop.i18nReplace("size_10","size_small");photoshop.i18nReplace("size_14","size_normal");photoshop.i18nReplace("size_18","size_large");photoshop.i18nReplace("size_32","size_huge");photoshop.i18nReplace("t_color","color");photoshop.i18nReplace("t_save","save");photoshop.i18nReplace("t_upload","upload");photoshop.i18nReplace("t_close","close");$("btn_crop").addEventListener("click",function(){if(photoshop.flag!=="crop"){photoshop.createCropArea()}photoshop.flag="crop";photoshop.markCurrentElement(this);photoshop.isDraw=false},false);$("btn_rectangle").addEventListener("click",function(){photoshop.toDo(this,"rectangle")},false);$("btn_radius_rectangle").addEventListener("click",function(){photoshop.toDo(this,"radiusRectangle")},false);$("btn_ellipse").addEventListener("click",function(){photoshop.toDo(this,"ellipse")},false);$("btn_line").addEventListener("click",function(){localStorage.lineType="line";photoshop.toDo(this,"line")},false);$("btn_arrow").addEventListener("click",function(){localStorage.lineType="arrow";photoshop.toDo(this,"arrow")},false);$("btn_blur").addEventListener("click",function(){photoshop.toDo(this,"blur")},false);$("btn_text").addEventListener("click",function(){photoshop.toDo(this,"text")},false);$("btn_undo").addEventListener("click",function(){photoshop.undo()},false);photoshop.toDo($("btn_rectangle"),"rectangle");var b=localStorage.fontSize=localStorage.fontSize||14;if(b!=10&&b!=14&&b!=18&&b!=32){localStorage.fontSize=14}photoshop.setFontSize(localStorage.fontSize);$("size_10").addEventListener("click",function(){photoshop.setFontSize(10)},false);$("size_14").addEventListener("click",function(){photoshop.setFontSize(14)},false);$("size_18").addEventListener("click",function(){photoshop.setFontSize(18)},false);$("size_32").addEventListener("click",function(){photoshop.setFontSize(32)},false);$("colors_pad").appendChild(photoshop.createColorPadEl("colors"));var a=localStorage.color||"#FF0000";photoshop.colorPadPick(a)},initCanvas:function(){$("canvas").width=$("mask_canvas").width=photoshop.canvas.width=bg.screenshot.canvas.width;$("photo").style.width=bg.screenshot.canvas.width+"px";$("canvas").height=$("mask_canvas").height=photoshop.canvas.height=bg.screenshot.canvas.height;$("photo").style.height=bg.screenshot.canvas.height+"px";var a=photoshop.canvas.getContext("2d");a.drawImage(bg.screenshot.canvas,0,0);a=$("canvas").getContext("2d");a.drawImage(photoshop.canvas,0,0);$("canvas").style.display="block"},init:function(){photoshop.initTools();photoshop.initCanvas();photoshop.tabTitle=bg.screenshot.tab.title;var a=function(){photoshop.setUnfilled();$("show_box").style.height=window.innerHeight-photoshop.offsetY-1+"px"};setTimeout(a,50)}};window.addEventListener("load",function(){document.title=chrome.i18n.getMessage("editPageTitle");photoshop.init();$("photo").addEventListener("mousedown",photoshop.onMouseDown,false);$("photo").addEventListener("mousemove",photoshop.onMouseMove,false);$("photo").addEventListener("mouseup",photoshop.onMouseUp,false);document.addEventListener("mousemove",photoshop.onMouseMove,false);document.addEventListener("mouseup",photoshop.onMouseUp,false);$("canvas").addEventListener("selectstart",function(){return false});$("mask_canvas").addEventListener("selectstart",function(){return false});setTimeout(function(){UploadUI.showDialog()},100);var b=document.querySelector("#pin_wrapper .image-picker .carousel-clip");var c=new Image();c.src=$("canvas").toDataURL("image/png");b.appendChild(c);$("description").value=bg.screenshot.page_info.text;$("url").value=bg.screenshot.page_info.href;var a=Huaban.getUser();UploadUI.init(a);if(!a){UploadUI.showAuth()}else{UploadUI.showUser(a);UploadUI.getBoards(a)}$("auth_btn").addEventListener("click",function(){UploadUI.showLoading();UploadUI.getAccessToken()});$("btn_upload").addEventListener("click",function(){photoshop.draw();c.src=$("canvas").toDataURL("image/png");UploadUI.showDialog();photoshop.finish()});$("btn_close").addEventListener("click",function(){chrome.tabs.query({active:true,currentWindow:true},function(d){chrome.tabs.remove(d[0].id)})})});