"use strict";var _gaq=_gaq||[];var bookmarkletUrl="https://huaban.com/js/widgets.min.js?"+Math.floor(new Date()/10000000);(function(){var a=function(b){chrome.tabs.query({active:true,currentWindow:true},function(d){var e=d[0];var f=e.url;f=f.replace(/^https?:\/\/(www)?/,"");if(f.indexOf(DOMAIN)==0){return}if(b.mediaType=="image"&&b.srcUrl&&b.srcUrl.indexOf("data:")!=0){var c={src:b.srcUrl||"",url:b.pageUrl||"",img:{alt:"",src:b.srcUrl,width:0,height:0}};chrome.tabs.sendMessage(e.id,{msg:"pinImage",data:c},function(g){});_gaq.push(["_trackEvent","contextMenu","pinImage"])}else{chrome.tabs.sendMessage(e.id,{msg:"showValidImages"},function(g){});_gaq.push(["_trackEvent","contextMenu","showValidImages"])}})};chrome.contextMenus.create({title:chrome.i18n.getMessage("pinAllText"),contexts:["all"],documentUrlPatterns:["http://*/*","https://*/*"],onclick:a})}());chrome.runtime.onMessage.addListener(function(e,g,d){switch(e.msg){case"settings":var b=localStorage.minWidth||200;b=parseInt(b);b=b<100?100:b;d({isToggleOn:!(localStorage.toggle=="off"),minWidth:b});break;case"bookmarklet":ajax({url:bookmarkletUrl,parameters:{},success:function(j){try{chrome.tabs.executeScript(g.tab.id,{code:j},function(l){if(chrome.runtime.lastError){console.error("Error in executeScript bookmarklet:",chrome.runtime.lastError.message);d({err:"采集工具不可用"})}else{d({msg:"success"})}})}catch(k){}}});return true;case"isToggleOn":d({isToggleOn:!(localStorage.toggle=="off")});break;case"toggle":var a=!!e.msg.toggle||!(localStorage.toggle=="on");localStorage.toggle=a?"on":"off";var i=a?"/images/logo_48.png":"/images/logo_48_gray.png";chrome.browserAction.setIcon({path:i});chrome.tabs.query({active:true,currentWindow:true},function(j){chrome.tabs.sendMessage(j[0].id,{msg:"toggle",isToggleOn:a},function(k){})});_gaq.push(["_trackEvent","toggle",localStorage.toggle]);d({isToggleOn:a});break;case"minWidth":var b=localStorage.minWidth||100;b=parseInt(b);b=b<100?100:b;d({minWidth:b});break;case"ga":_gaq.push(["_trackEvent",e.type,e.value]);d({});break;case"isLogin":var f=Huaban.getUser();Huaban.currentUserId=f&&f.id||undefined;d({user:f});break;case"requireLogin":var c=Huaban;var f;var h=function(j,k){if(j=="success"){f=k;chrome.tabs.update(g.tab.id,{selected:true});Huaban.getUserInfo(k,function(m,n,p){if(m=="success"){var o=f.id;if(!Huaban.getUser(o)){Huaban.currentUserId=o;Huaban.addUser(f)}}})}else{var l=null;if(k=="access_denied"||k=="invalid_grant"){l=k}if(l){l=chrome.i18n.getMessage(l)}else{l=k}console.log("auth failed")}};Huaban.getAccessToken(h);break;case"request":Huaban.postPin(e.data.data,function(j,l){var k={};if(j=="failure"){}else{k.msg="success";k.data=l}d(k)});return true;default:break}});var screenshot={tab:0,canvas:document.createElement("canvas"),startX:0,startY:0,scrollX:0,scrollY:0,docHeight:0,docWidth:0,visibleWidth:0,visibleHeight:0,scrollXCount:0,scrollYCount:0,scrollBarX:17,scrollBarY:17,captureStatus:true,handleHotKey:function(a){if(HotKey.isEnabled()){switch(a){case HotKey.getCharCode("area"):screenshot.showSelectionArea();break;case HotKey.getCharCode("viewport"):screenshot.captureViewport();break;case HotKey.getCharCode("fullpage"):screenshot.captureFullpage();break;case HotKey.getCharCode("screen"):screenshot.captureScreen();break}}},addMessageListener:function(){chrome.runtime.onMessage.addListener(function(c,b,a){var d=c;switch(d.msg){case"capture_hotkey":screenshot.handleHotKey(d.keyCode);break;case"capture_selected":screenshot.captureSelected();break;case"capture_area":screenshot.showSelectionArea();break;case"capture_viewport":screenshot.captureViewport();break;case"capture_fullpage":screenshot.captureFullpage();break}})},sendMessage:function(a,b){chrome.tabs.query({active:true,currentWindow:true},function(c){chrome.tabs.sendMessage(c[0].id,a,b)})},captureViewport:function(){screenshot.sendMessage({msg:"capture_viewport"},screenshot.onResponseVisibleSize)},captureFullpage:function(){screenshot.sendMessage({msg:"scroll_init"},screenshot.onResponseVisibleSize)},showSelectionArea:function(){screenshot.sendMessage({msg:"show_selection_area"},null)},captureSelected:function(){screenshot.sendMessage({msg:"capture_selected"},screenshot.onResponseVisibleSize)},captureVisible:function(b){var a=localStorage.screenshootQuality||"png";chrome.tabs.captureVisibleTab(null,{format:a,quality:50},function(c){var d=new Image();d.onload=function(){var g;var e;if(Utils.isRetinaDisplay()){g=d.width;e=d.height}else{g=screenshot.visibleWidth;e=screenshot.visibleHeight}screenshot.canvas.width=g;screenshot.canvas.height=e;var f=screenshot.canvas.getContext("2d");f.drawImage(d,0,0,g,e,0,0,g,e);screenshot.postImage(b)};d.src=c})},captureAndScroll:function(b){var a=localStorage.screenshootQuality||"png";chrome.tabs.captureVisibleTab(null,{format:a,quality:50},function(c){var d=new Image();d.onload=function(){var g=screenshot.canvas.getContext("2d");var f=0;var m=0;screenshot.scrollBarY=screenshot.visibleHeight<screenshot.docHeight?17:0;screenshot.scrollBarX=screenshot.visibleWidth<screenshot.docWidth?17:0;var j=(d.width-screenshot.scrollBarY<screenshot.canvas.width?d.width-screenshot.scrollBarY:screenshot.canvas.width);var i=(d.height-screenshot.scrollBarX<screenshot.canvas.height?d.height-screenshot.scrollBarX:screenshot.canvas.height);var n=screenshot.zoom;var h=screenshot.startX-Math.round(screenshot.scrollX*n);var e=0;var l=screenshot.startY-Math.round(screenshot.scrollY*n);var k=0;if((screenshot.scrollYCount+1)*j>screenshot.canvas.width){f=screenshot.canvas.width%j;h=(screenshot.scrollYCount+1)*j-screenshot.canvas.width+screenshot.startX-screenshot.scrollX}else{f=j}if((screenshot.scrollXCount+1)*i>screenshot.canvas.height){m=screenshot.canvas.height%i;if((screenshot.scrollXCount+1)*i+screenshot.scrollY<screenshot.docHeight){l=0}else{l=(screenshot.scrollXCount+1)*i+screenshot.scrollY-screenshot.docHeight}}else{m=i}e=screenshot.scrollYCount*j;k=screenshot.scrollXCount*i;g.drawImage(d,h,l,f,m,e,k,f,m);screenshot.sendMessage({msg:"scroll_next",visibleWidth:j,visibleHeight:i},screenshot.onResponseVisibleSize)};d.src=c})},captureAndScrollDone:function(a){screenshot.postImage(a)},postImage:function(a){chrome.tabs.query({active:true,currentWindow:true},function(b){screenshot.tab=b[0];screenshot.page_info=a});chrome.tabs.create({url:"edit.html"})},onResponseVisibleSize:function(a){switch(a.msg){case"capture_viewport":screenshot.visibleHeight=a.visibleHeight;screenshot.visibleWidth=a.visibleWidth;screenshot.captureVisible(a.page_info);break;case"scroll_init_done":screenshot.startX=a.startX;screenshot.startY=a.startY;screenshot.scrollX=a.scrollX;screenshot.scrollY=a.scrollY;screenshot.canvas.width=a.canvasWidth;screenshot.canvas.height=a.canvasHeight;screenshot.visibleHeight=a.visibleHeight;screenshot.visibleWidth=a.visibleWidth;screenshot.scrollXCount=a.scrollXCount;screenshot.scrollYCount=a.scrollYCount;screenshot.docWidth=a.docWidth;screenshot.docHeight=a.docHeight;screenshot.zoom=a.zoom;setTimeout(function(){screenshot.captureAndScroll(a.page_info)},100);break;case"scroll_next_done":screenshot.scrollXCount=a.scrollXCount;screenshot.scrollYCount=a.scrollYCount;setTimeout(function(){screenshot.captureAndScroll(a.page_info)},100);break;case"scroll_finished":screenshot.captureAndScrollDone(a.page_info);break}},executeScriptsInExistingTabs:function(){chrome.windows.getAll(null,function(b){for(var a=0;a<b.length;++a){chrome.tabs.getAllInWindow(b[a].id,function(d){for(var c=0;c<d.length;++c){if(!/chrome.*:\/\/*/g.test(d[c].url)){try{chrome.tabs.executeScript(d[c].id,{file:"js/page.js"});chrome.tabs.executeScript(d[c].id,{file:"js/shortcut.js"})}catch(f){}}}})}})},init:function(){localStorage.screenshootQuality=localStorage.screenshootQuality||"png";screenshot.addMessageListener()}};screenshot.init();HotKey.setup();(function(){var a=localStorage.toggle=="off"?"/images/logo_48_gray.png":"/images/logo_48.png";chrome.browserAction.setIcon({path:a})})();(function(){if(localStorage.notFirstRun=="yes"){return}localStorage.notFirstRun="yes";chrome.tabs.create({url:"http://"+DOMAIN+"/about/?md=chrome_ex",selected:true})})();(function(){chrome.runtime.onMessage.addListener(function(c,b){switch(c.msg){case"url_for_access_token":var a=c.url;if(Huaban.isRedirectUrl(a)){chrome.tabs.remove(b.tab.id);Huaban.parseAccessToken(a)}break}})})();